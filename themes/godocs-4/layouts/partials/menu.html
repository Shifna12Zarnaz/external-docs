{{ $currentNode := . }}
{{ $isChangelogSection := eq .Section "changelog" }}
{{ $currentChangelogNode := site.GetPage "/changelog/" }}
{{ $currentTopic := delimit (first 3 (split .RelPermalink "/")) "/" }}
{{ $currentPageVersion := index (findRE `(\d+\.\d+\.\d+)` .RelPermalink) 0 | default site.Params.latestDocVersion }}

<ul
  id="{{ $currentPageVersion }}"
  class="version-tree menu d-none py-4 pe-4 ps-0 border-end border-default mb-0">
  <!-- For Topics -->
  {{- range (where site.Pages ".Params.Type" "==" "docs") }}
    {{ $sectionNode := delimit (first 3 (split .RelPermalink "/")) "/" }}

    {{ if eq $currentTopic $sectionNode }}
      {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode }}
    {{ end }}
  {{- end }}


  <!-- For Changelog -->
  {{- range (where site.Pages ".Params.Type" "==" "changelog") }}
    {{ $sectionNode := delimit (first 4 (split .RelPermalink "/")) "/" }}

    {{ if findRE $currentPageVersion $sectionNode }}
      {{ if $isChangelogSection }}
        {{- template "section-tree-nav" dict "sect" . "currentnode" $currentChangelogNode }}
      {{ end }}
    {{ end }}
  {{- end }}
</ul>

<script>
  let versionTree = document.querySelectorAll(".version-tree");
  versionTree.forEach((el, i) => {
    let id = el.getAttribute("id");
    if (id == urlVersion) {
      el.classList.remove("d-none");
    } else {
      if (el.classList.contains("version-tree")) {
        el.remove();
      }
    }
  });
</script>

<!-- templates -->
{{- define "section-tree-nav" }}
  {{ $currentNode := .currentnode }}
  {{- with .sect }}
    {{- if .IsSection }}
      {{- $numberOfPages := (add (len .Pages) (len .Sections)) }}
      {{- safeHTML .Params.head }}
      <li
        data-nav-id="{{ .Permalink }}"
        class="sidenav-item  {{ if ne $numberOfPages 0 }}haschildren{{ end }}">
        <div>
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
          {{- if ne $numberOfPages 0 }}
            <div class="category-icon">
              <i class="fa fa-angle-right fa-lg"></i>
            </div>
          {{- end }}
        </div>

        {{- if ne $numberOfPages 0 }}
          <ul>
            {{- $pages := .Pages }}
            {{- if .Sections }}
              {{- $pages = (.Pages | union .Sections) }}
            {{- end }}
            {{- range $pages.ByWeight }}
              {{- template "section-tree-nav" dict "sect" . }}
            {{- end }}
          </ul>
        {{- end }}
      </li>
    {{- end }}
  {{- end }}
{{- end }}
